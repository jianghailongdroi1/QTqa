{% extends "base.html" %}
{% block title %}新增任务{% endblock %}
{% load staticfiles %}
{% block content %}

<link rel="stylesheet" href="{% static 'assets/css/bootstrap-datetimepicker.css' %}" />


                <div class="main-content">
                    <div class="breadcrumbs" id="breadcrumbs">
                        <script type="text/javascript">
                            try{ace.settings.check('breadcrumbs' , 'fixed')}catch(e){}
                        </script>
                        <ul class="breadcrumb">
                            <li>
                                <i class="icon-home home-icon"></i>
                                <a href="#">首页</a>
                            </li>
                            <li class="active">编辑任务</li>
                        </ul><!-- .breadcrumb -->
                    </div>
                    <div class="page-content">
                        <div class="page-header">
                            <h1>
                                任务中心
                                <small>
                                    <i class="icon-double-angle-right"></i>
                                    编辑任务
                                </small>
                            </h1>
                        </div><!-- /.page-header -->
                        <div class="row">
                            <div class="col-xs-12">
                                <!-- PAGE CONTENT BEGINS -->
                                <form class="form-horizontal" role="form">
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label no-padding-right" for="form-field-1">任务名称 </label>
                                        <div class="col-sm-9">
                                            <input type="text" id="job_name" placeholder="请输入任务名称" class="col-xs-10 col-sm-5" />
                                        </div>
                                    </div>
                                    <div class="space-4"></div>
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label no-padding-right" for="form-field-1">所属项目</label>
                                        <div class="col-sm-9">
                                            <select class="col-xs-10 col-sm-5" id="project_code">
                                                <option value="0">请选择</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label no-padding-right" for="form-field-1">关联Suite</label>
                                        <div class="col-sm-9">
                                            <select class="col-xs-12 col-sm-5" id="related_suite" multiple="multiple">
                                                <option value="0">请选择</option>

                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label no-padding-right" for="form-field-1">任务类型</label>
                                        <div class="col-sm-9">
                                            <select class="col-xs-10 col-sm-5" id="form-field-select-3" name="form-field-select-3">
                                                <option value="instant_task">立即执行</option>
                                                <option value="called_task">第三方调用</option>
                                                <option value="timing_task">定时任务</option>
                                            </select>
                                        </div>
                                    </div>
                                <div style="display:none" id = "hide1">
                                    <div class="form-group">
                                       <label class="col-sm-3 control-label no-padding-right" for="form-field-1">任务开始时间</label>
                                        <div class="col-sm-9">
                                            <input type="text" id="datepicker" class= "col-xs-10 col-sm-5" />
                                            <i class="icon-calendar"></i>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                       <label class="col-sm-3 control-label ">任务执行次数 </label>
                                       <div class="col-sm-2">
                                            <input type="text" id="maximum_times" placeholder="" class="col-xs-10 col-sm-5" type="number" onkeyup="this.value=this.value.replace(/\D/g,'')"  onafterpaste="this.value=this.value.replace(/\D/g,'')"/>
                                            <i>次</i>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                       <label class="col-sm-3 control-label no-padding-right" for="form-field-1">间隔时间 </label>
                                       <div class="col-sm-2">
                                            <input type="text" id="iterval_time" placeholder="" class="col-xs-10 col-sm-5" 
                                             type="number" onkeyup="this.value=this.value.replace(/\D/g,'')"  onafterpaste="this.value=this.value.replace(/\D/g,'')" />
                                            <i>分钟/次</i>
                                        </div>
                                    </div>
                                </div>  
                                    <div class="form-group">
                                        <label class="col-sm-3 control-label no-padding-right" for="form-field-1">任务描述 </label>
                                        <div class="col-sm-9">
                                            <input type="text" id="description" placeholder="用一句话来描述这个任务吧~" class="col-xs-10 col-sm-5"/>
                                        </div>
                                    </div>
                                    <div class="form-group" id="default-buttons">
                                            <label class="col-sm-3 control-label no-padding-right" for="form-field-1">任务是否开启：</label>
                                            <div class="col-sm-9">
                                                <input id="id-button-borders" checked="" type="checkbox" class="ace ace-switch ace-switch-5" />
                                                <span class="lbl"></span>
                                            </div>
                                         </label>
                                    </div>
                                    <div class="clearfix form-actions">
                                        <div class="col-md-offset-3 col-md-9">
                                           <button class="btn btn-info" type="button" data-url="" data-id="add_task" onclick="requestClick(this)">
                                                <i class="icon-ok bigger-110"></i>
                                                保存
                                            </button>
                                            &nbsp; &nbsp; &nbsp;
                                            <button class="btn" type="reset">
                                                <i class="icon-undo bigger-110"></i>
                                                重置
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div><!-- /.col -->
                        </div><!-- /.row -->
                    </div><!-- /.page-content -->
                </div><!-- /.main-content -->
<script src="http://www.jq22.com/jquery/jquery-2.1.1.js"></script>
<!-- <script src="{% static 'assets/js/jquery-ui-1.10.3.full.min.js' %}"></script>
 --><script src="{% static 'assets/js/date-time/bootstrap-datetimepicker.min.js' %}"></script>
<script src="{% static 'assets/js/chosen.jquery.min.js' %}"></script>




<script type="text/javascript">
        // $("p").hide();
        // var show = children('option:selected').val()
        // if (show = 1) {
    $("#form-field-select-3").change(function(){
        var a = $(this).val();
        if(a=="timing_task"){
            $("#hide1").show();
        }
        else{
            $("#hide1").hide();
        }
        });
    $( "#datepicker" ).datetimepicker({
        // minuteStep: 1,
        //         appendWidgetTo: 'body',
        //         showSeconds: true,
        //         showMeridian: false,
        //         defaultTime: false

    });

    $.ajax({
                    type:"get",
                    url:"/autotest/3/SearchForProject/",
                    dataType: "json",
                    success:function(res){
                        var list = res.all_projects;
                        for(var i in list){
                            $("#project_code").append("<option value='" + list[i].id + "'>" + list[i].project_name + "</option>");
                        }
                    }
                });



     function getUrlParam(name) {
             var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象  
             var r = window.location.search.substr(1).match(reg);  //匹配目标参数   
             if (r != null) return unescape(r[2]); return null; //返回参数值  
    };

    $.ajax({
        type:"post",
        url:"/autotest/5/query_job_detail/",
        dataType: "json",
        data:{
            job_id: getUrlParam("id")
        } ,
        success:function(res){
            var suitelist = res.data;
            $("#job_name").val(suitelist.job_name);
            console.log(suitelist.suite_list);
            $("#project_code option[value='"+suitelist.project_id+"']").attr("selected",true);
            $.ajax({
                    type:"post",
                    url:"/autotest/1/SearchForSuite/",
                    data:{
                        project_id: suitelist.project_id
                    },
                    dataType: "json",
                    success:function(res){
                        var list = res.rows;
                        for(var i in list){
                            $("#related_suite").append("<option value='" + list[i].id + "'>" + list[i].suite_name + "</option>"); 
                        // $("#related_suite").trigger("liszt:updated");
                        for(var z=0; z<suitelist.suite_list.length;z++){
                            console.log("aaaaa" + suitelist.suite_list[z].id)
                            $("#related_suite option[value='"+suitelist.suite_list[z].id+"']").attr("selected",true);
            };
                        }
                    }
                });

            $("#description").val(suitelist.description);
            if(suitelist.type == "timing_task"){
                $("#hide1").show();
                $("#datepicker").val(suitelist.time_start_excute);
                $("#iterval_time").val(suitelist.iterval_time);
                $("#maximum_times").val(suitelist.maximum_times);

            };
    }
});





    $("#project_code").change(function(){
        var id0 = $("#project_code option:selected").val();
        $("#related_suite").empty();
        $.ajax({
                    type:"post",
                    url:"/autotest/1/SearchForSuites/",
                    data:{
                        project_id: id0
                    },
                    dataType: "json",
                    success:function(res){
                        var list = res.rows;
                        for(var i in list){
                            $("#related_suite").append("<option value='" + list[i].id + "'>" + list[i].suite_name + "</option>"); 
                        $("#related_suite").trigger("liszt:updated");

                        }
                    }
           })
        // $(".related_suite").chosen().change(function(){
        //                 $("#related_suite").trigger("liszt:updated");
        //                 })
    });
    

    function requestClick(obj) {
                    var url = "/autotest/5/edit_job/";
                    // var id = $(obj).attr('data-id');
                    var job_name0 = $(" #job_name ").val();
                    var select = document.getElementById("related_suite");
                    var suite_list0 = [];

                    for(i=0;i<select.length;i++){
                        if(select.options[i].selected){
                            suite_list0.push(Number(select[i].value));
                        }
                    };

                    var job_id =$(" #related_suite option:selected").val();
                    // var suite_list = [];
                    var project_id0 = $(" #project_code option:selected").val();
                    // var suite_list0 = $(" #suite_list ").val();
                    var description0 = $(" #description ").val();
                    var time_start_excute0 = $(" #datepicker ").val();
                    var iterval_time0 = $(" #iterval_time").val(); ;
                    var maximum_times0 =$(" #maximum_times ").val();
                    var job_type0 = $("#form-field-select-3 option:selected").val();
                    var p = {
                        job_id: getUrlParam("id"),
                        job_name:job_name0, 
                        suite_list: JSON.stringify(suite_list0),
                        description:description0,
                        job_type:job_type0,
                        time_start_excute:time_start_excute0,
                        iterval_time:iterval_time0,
                        maximum_times:maximum_times0,
                        project_id: project_id0,
                    };
                    console.log(obj)
                    jQuery.ajaxSettings.traditional = true;
                    $.post(url, p, function(data, status){
                        var json = eval("("+data+")")
                        if(json.code == '200'){
                            window.location.href = "/backend/task_list/";
                        }else{
                        alert(json.msg)
                    }
                        })
                }
            
</script>
{% endblock %}